F_URI="/capture/form/",captureApp.controller("captureFormStockUndoCtrl",["$scope","$http","Idle",function(o,e,r){function f(e){var r=o.form.flds.length;(!o.form.flds[e].group||r-1>e&&o.form.flds[e].group!=o.form.flds[e+1].group)&&(o.form.flds.length=e+1)}function t(r,f,t){function s(e){o.form=e[0],o.formMsgType=e[1],o.formMsg=e[2],o.bbox=e[3],l()}"undefined"==typeof f?e.get(F_URI+r).success(s).error(n):e.post(F_URI+o.form.name+"/fld_"+f,t).success(s).error(n)}function n(e){e=parseErrorResponse(e),"redirectTo"in e?window.location.replace(e.redirectTo):(o.errDialog=e,showErrDialog())}function l(){setTimeout(function(){var e="#"+o.form.name+"-"+o.form.flds[o.form.flds.length-1].name;$(".ajaxLoaded").trigger("create"),$(e).focus()},0)}o.aqcUtils=aqcUtils,o.events=[],o.$on("IdleStart",function(){showPopupDialog("idleDetected")}),o.$on("IdleWarn",function(o,e){$("#idleCountdown").html("Reset in "+e+"s")}),o.$on("IdleTimeout",function(){$("#idleCountdown").html("Reloading..."),o.reload()}),o.$on("IdleEnd",function(){hidePopupDialog("idleDetected")}),o.$on("Keepalive",function(){}),o.init=function(e){o.hideDesc=!1,e&&t(e)},o.reload=function(e){e=e||o.form.name,window.location.href=e+".html"},o.gotFocus=function(e){2==o.form.flds[e].w2cm&&(o.form.flds[e].msg=""),f(e)},o.change=function(e){r.watch(),o.formMsg="",1==o.form.flds[e].w2cm&&(o.form.flds[e].msg=""),o.form.flds[e].dirty=!0},o.entryDone=function(e,r){e>o.form.flds.length-1||(r=r||!1,(o.form.flds[e].dirty||r)&&(o.form.flds[e].dirty=!1,3==o.form.flds[e].w2cm&&(o.form.flds[e].msg=""),t(o.form.name,o.form.flds[e].name,{value:o.form.flds[e].value})))},o.detailShow=function(r,f,t){function s(e){"!flds"==e[0]?o.form.flds.push.apply(o.form.flds,e[3]):o.curItemDetail=e[0],$("body").pagecontainer("change","#pageItemDetail",{transition:"slidedown"}),setTimeout(function(){$("#pageItemDetail").trigger("create"),$(".ui-listview").listview("refresh")},0),l()}o.formMsg="",o.curItem=t,o.curIdx=aqcUtils.getFldIdx(o.form,r),e.post(F_URI+o.form.name+"/"+f,t).success(s).error(n)},o.detEntryDone=function(r,t){function s(e){"!flds"==e[0]?(f(o.curIdx),o.form.flds.push.apply(o.form.flds,e[3])):($.mobile.back(),o.form=e[0],o.formMsgType=e[1],o.formMsg=e[2],o.bbox=e[3]),l()}r>o.form.flds.length-1||(t=t||!1,(o.form.flds[r].dirty||t)&&(o.form.flds[r].dirty=!1,3==o.form.flds[r].w2cm&&(o.form.flds[r].msg=""),e.post(F_URI+o.form.name+"/fld_"+o.form.flds[r].name,{stkTiItem:o.curItem,value:o.form.flds[r].value}).success(s).error(n)))},o.detailCancel=function(){$.mobile.back(),f(o.curIdx)}}]);