F_URI="/capture/form/",captureApp.controller("captureFormCtrl",["$scope","$http","Idle","localService",function(o,e,n,t){function r(e){var n=o.form.flds.length;(!o.form.flds[e].group||n-1>e&&o.form.flds[e].group!=o.form.flds[e+1].group)&&(o.form.flds.length=e+1)}function l(n,t,r){function l(e){o.form=e[0],o.formMsgType=e[1],o.formMsg=e[2],o.bbox=e[3],i()}"undefined"==typeof t?e.get(F_URI+n).success(l).error(f):e.post(F_URI+o.form.name+"/fld_"+t,r).success(l).error(f)}function f(e){e=parseErrorResponse(e),"redirectTo"in e?window.location.replace(e.redirectTo):(o.errDialog=e,showErrDialog())}function i(){setTimeout(function(){var e="#"+o.form.name+"-"+o.form.flds[o.form.flds.length-1].name;$(".ajaxLoaded").trigger("create"),$(e).focus()},0)}o.localService=t,o.aqcUtils=aqcUtils,o.events=[],o.$on("IdleStart",function(){showPopupDialog("idleDetected")}),o.$on("IdleWarn",function(o,e){$("#idleCountdown").html("Reset in "+e+"s")}),o.$on("IdleTimeout",function(){$("#idleCountdown").html("Reloading..."),o.reload()}),o.$on("IdleEnd",function(){hidePopupDialog("idleDetected")}),o.$on("Keepalive",function(){}),o.init=function(e){o.hideDesc=!1,e&&l(e)},o.reload=function(e){e=e||o.form.name,window.location.href=e+".html"},o.gotFocus=function(e){2==o.form.flds[e].w2cm&&(o.form.flds[e].msg=""),r(e)},o.change=function(e){n.watch(),o.formMsg="",1==o.form.flds[e].w2cm&&(o.form.flds[e].msg=""),o.form.flds[e].dirty=!0},o.entryDone=function(e,n){e>o.form.flds.length-1||(n=n||!1,(o.form.flds[e].dirty||n)&&(o.form.flds[e].dirty=!1,3==o.form.flds[e].w2cm&&(o.form.flds[e].msg=""),l(o.form.name,o.form.flds[e].name,{value:o.form.flds[e].value})))},o.detailShow=function(n,t,r){function l(e){"!flds"==e[0]?o.form.flds.push.apply(o.form.flds,e[3]):o.curItemDetail=e[0],$("body").pagecontainer("change","#pageItemDetail",{transition:"slidedown"}),setTimeout(function(){$("#pageItemDetail").trigger("create"),$(".ui-listview").listview("refresh")},0)}o.formMsg="",o.curItem=r,o.curIdx=n,e.post(F_URI+o.form.name+"/"+t,r).success(l).error(f),i()},o.detailCancel=function(){$.mobile.back(),r(o.curIdx)},o.lookupShow=function(e,n,t,r){o.gotFocus(aqcUtils.getFldIdx(o.form,e.name)),o.lookupFld=e,o.lookupItems=n,o.lookupCurVal=defaultFor(r,e.value),$("body").pagecontainer("change","#"+t,{transition:"slidedown"}),setTimeout(function(){$("#"+t).trigger("create"),$(".ui-listview").listview("refresh")},0)},o.lookupSave=function(e){$.mobile.back(),l(o.form.name,o.lookupFld.name,{value:e.code})},o.lookupCancel=function(){$.mobile.back()}}]);